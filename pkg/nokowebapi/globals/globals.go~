package globals

import (
	"nokowebapi/cores"
)

var Defaults = cores.MapAny{
	"jwt": cores.MapAny{
		"algorithm":  "HS256",
		"audience":   "your-audience",
		"issuer":     "your-issuer",
		"secretKey":  "your-secret-key",
		"expiresIn": "1h",
	},
	"logger": cores.MapAny{
		"development":       true,
		"level":             "debug",
		"encoding":          "console",
		"stackTraceEnabled": true,
	},
}

type ConfigurationImpl interface {
	GetJwtConfig() *cores.JwtConfig
	GetLoggerConfig() *LoggerConfig
	Keys() []string
	Values() []any
	Get(key string) any
}

type Configuration struct {
	JwtConfig    *cores.JwtConfig
	LoggerConfig *LoggerConfig
}

func NewConfiguration() ConfigurationImpl {
	return &Configuration{
		JwtConfig:    nil,
		LoggerConfig: nil,
	}
}

func (c *Configuration) GetJwtConfig() *cores.JwtConfig {
	if c.JwtConfig != nil {
		return c.JwtConfig
	}
	// pass as you go
	c.JwtConfig = JwtConfigGlobals()
	return c.JwtConfig
}

func (c *Configuration) GetLoggerConfig() *LoggerConfig {
	if c.LoggerConfig != nil {
		return c.LoggerConfig
	}
	// pass as you go
	c.LoggerConfig = LoggerConfigGlobals()
	return c.LoggerConfig
}

func (c *Configuration) Keys() []string {
	return []string{
		cores.GetName(c.GetJwtConfig()),
		cores.GetName(c.GetLoggerConfig()),
	}
}

func (c *Configuration) Values() []any {
	return []any{
		c.GetJwtConfig(),
		c.GetLoggerConfig(),
	}
}

func (c *Configuration) Get(key string) any {
	keys := c.Keys()
	values := c.Values()

	// out of case
	if len(keys) != len(values) {
		panic("invalid configuration")
	}

	// search value by key
	for i, k := range keys {
		if k == key {
			return values[i]
		}
	}

	// not found
	return nil
}

var globals ConfigurationImpl

func Globals() ConfigurationImpl {
	if globals != nil {
		return globals
	}
	globals = NewConfiguration()
	return globals
}
